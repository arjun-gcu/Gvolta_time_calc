
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GCU - Gvolta充電時間計算機</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    color: #f1f1f1;
    padding: 30px 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    margin: 0;
  }
  .container {
    max-width: 800px;
    width: 100%;
    background-color: rgba(44, 62, 80, 0.85);
    border-radius: 12px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
    padding: 30px 40px;
    box-sizing: border-box;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
    font-size: 1.8rem;
    font-weight: 700;
  }
  .lang-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  .lang-buttons button {
    padding: 8px 16px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
  }
  .btn-jp { background-color: #28a745; color: white; }
  .btn-en { background-color: #ff9800; color: white; }
  .section-title {
    margin-top: 15px;
    font-weight: bold;
    margin-bottom: 10px;
  }
  .input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  .input-with-unit {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
  }
  .input-with-unit input {
    flex: 1;
    min-width: 100px;
    padding: 10px;
    font-size: 1rem;
    border: 1.8px solid #a0aec0;
    border-radius: 8px;
    background-color: #1e293b;
    color: #e2e8f0;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.6);
  }
  .unit-label {
    font-size: 0.95rem;
    color: #cbd5e1;
    white-space: nowrap;
  }
  .note {
    font-size: 0.85rem;
    color: #d1d5db;
    margin-bottom: 15px;
  }
  .output-section {
    background-color: #334155;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    text-align: center;
  }
  .output-wrapper {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 10px;
    align-items: center;
  }
  .output-box {
    background-color: #1e293b;
    padding: 8px;
    border-radius: 6px;
    font-size: 1.1rem;
    width: 120px;
    text-align: center;
    border: 1px solid #999;
    color: #f1f1f1;
  }
  .tag { font-weight: bold; }
  .buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
  }
  button.calc-btn {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    transition: background 0.3s ease;
    background: linear-gradient(90deg, #4ca1af, #2c3e50);
    color: #e0e7ff;
  }
  button.calc-btn:hover {
    background: linear-gradient(90deg, #3a91a0, #1f2d3c);
  }
  button.clear-btn {
    flex: 1;
    background: #d9534f;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
  }
  button.clear-btn:hover { background: #c9302c; }
  .calculation-ref {
    background-color: #475569;
    padding: 15px;
    border-radius: 8px;
    font-size: 0.9rem;
    white-space: pre-line;
    margin-top: 20px;
  }
</style>
</head>
<body>
<div class="container">
  <h1 id="pageTitle">GCU - Gvolta充電時間計算機</h1>
  <div class="lang-buttons">
    <button class="btn-jp" onclick="setLanguage('jp')">日本語</button>
    <button class="btn-en" onclick="setLanguage('en')">ENG</button>
  </div>

  <div class="section-title" id="secInputTitle">3相AC入力（ブレーカー定格電流を入力）</div>
  <div class="input-group">
    <label class="input-with-unit">
      <input type="number" id="inputVoltage" min="100" max="2000" placeholder="例: 200" title="コンセントの電圧">
      <span class="unit-label" id="unitVolt1">V</span>
    </label>
    <label class="input-with-unit">
      <input type="number" id="inputCurrent" min="10" max="500" placeholder="例: 30" title="ブレカーのアンペア">
      <span class="unit-label" id="unitAmp1">A</span>
    </label>
  </div>

  <div class="section-title" id="secBattInfo">バッテリー情報</div>
  <div class="input-group">
    <label class="input-with-unit">
      <input type="number" id="batteryVoltage" min="10" max="1000" placeholder="例: 48" title="バッテリー電圧">
      <span class="unit-label" id="unitVolt2">V</span>
    </label>
    <label class="input-with-unit">
      <input type="number" id="batteryAh" min="1" max="2000" placeholder="例: 200"title="バッテリー容量">
      <span class="unit-label" id="unitAh">Ah</span>
    </label>
  </div>

  <div class="section-title" id="secSoc">バッテリー現在チャージ（SoC）％</div>
  <div class="input-with-unit" style="max-width:200px;">
    <input type="number" id="socPercent" min="0" max="100" placeholder="例: 50" title="バッテリー現状">
    <span class="unit-label" id="unitPercent">%</span>
  </div>
  <div class="note" id="socNote">
    例: 完全放電状態なら０％で、満充電状態なら１００％です。<br>
    例: 25%, 50%, 75%,　他。入力した％から１００％まで計算されます。
  </div>

  <div class="buttons">
    <button class="calc-btn" id="btnCalc" onclick="calculateTime()">計算</button>
    <button class="clear-btn" id="btnClear" onclick="clearFields()">削除</button>
  </div>

  <div class="output-section">
    <span class="tag" id="outCurrentTitle">GC出力電流（最大）：</span>
    <div class="output-wrapper">
      <div style="display:flex; align-items:center; gap:6px;">
        <span id="label13">13kW：</span>
        <div class="output-box" id="outputCurrent13">--</div>
        <span id="unitAmpOut">アンペア</span>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <span id="label21">21kW：</span>
        <div class="output-box" id="outputCurrent21">--</div>
        <span id="unitAmpOut2">アンペア</span>
      </div>
    </div>
  </div>

  <div class="output-section">
    <span class="tag" id="outTimeTitle">満充電までの所要時間：</span>
    <div class="output-wrapper">
      <div style="display:flex; align-items:center; gap:6px;">
        <span id="label13Time">13kW GCチャージャー：</span>
        <div class="output-box" id="time13kw">--</div>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <span id="label21Time">21kW GCチャージャー：</span>
        <div class="output-box" id="time21kw">--</div>
      </div>
    </div>
  </div>

  <div class="calculation-ref" id="calcRef">※選択された値に基づいた詳細計算を表示します。</div>
</div>

<script>
const langData = {
  jp: {
    pageTitle: "GCU - Gvolta充電時間計算機",
    secInputTitle: "3相AC入力（ブレーカー定格電流を入力）",
    secBattInfo: "バッテリー情報",
    secSoc: "バッテリー現在チャージ（SoC）％",
    socNote: "例: 完全放電状態なら０％で、満充電状態なら１００％です。<br>例: 0%, 25%, 50%, 75%,　他。入力した％から１００％まで計算されます。",
    btnCalc: "計算",
    btnClear: "削除",
    outCurrentTitle: "GC出力電流（最大）：",
    outTimeTitle: "満充電までの所要時間：",
    label13: "13kW：",
    label21: "21kW：",
    unitAmpOut: "アンペア",
    unitAmpOut2: "アンペア",
    label13Time: "13kW GCチャージャー：",
    label21Time: "21kW GCチャージャー：",
    unitVolt1: "V", unitAmp1: "A", unitVolt2: "V", unitAh: "Ah", unitPercent: "%"
  },
  en: {
    pageTitle: "GCU - Gvolta Charge Time Calculator",
    secInputTitle: "3-Phase AC Input (Breaker Rated Current)",
    secBattInfo: "Battery Information",
    secSoc: "Battery Current Charge (SoC) %",
    socNote: "Example: 0% means fully discharged, 100% means fully charged.<br>Example: 0%, 25%, 50%, 75%, etc. Time is calculated from entered % to 100%.",
    btnCalc: "Calculate",
    btnClear: "Clear",
    outCurrentTitle: "GC Output Current (Max):",
    outTimeTitle: "Time to Full Charge:",
    label13: "13kW:",
    label21: "21kW:",
    unitAmpOut: "Amps",
    unitAmpOut2: "Amps",
    label13Time: "13kW GC Charger:",
    label21Time: "21kW GC Charger:",
    unitVolt1: "V", unitAmp1: "A", unitVolt2: "V", unitAh: "Ah", unitPercent: "%"
  }
};

function setLanguage(lang) {
  const t = langData[lang];
  for (const key in t) {
    const el = document.getElementById(key);
    if (el) el.innerHTML = t[key];
  }
  // HTML lang
  document.documentElement.lang = (lang === 'en') ? 'en' : 'ja';

  // Placeholders
  document.getElementById("inputVoltage").placeholder = (lang === 'en') ? "Ex: 200" : "例: 200";
  document.getElementById("inputCurrent").placeholder = (lang === 'en') ? "Ex: 66" : "例: 66";
  document.getElementById("batteryVoltage").placeholder = (lang === 'en') ? "Ex: 48" : "例: 48";
  document.getElementById("batteryAh").placeholder = (lang === 'en') ? "Ex: 200" : "例: 200";
  document.getElementById("socPercent").placeholder = (lang === 'en') ? "Ex: 50" : "例: 50";

  // Tooltip for first box
  document.getElementById("inputVoltage").title = (lang === 'en') ? "Outlet voltage" : "コンセントの電圧";
  document.getElementById("inputCurrent").title = (lang === 'en') ? "Breaker amperage" : "ブレカーのアンペア";
  document.getElementById("batteryVoltage").title = (lang === 'en') ? "Battery voltage" : "バッテリー電圧";
  document.getElementById("batteryAh").title = (lang === 'en') ? "Battery capacity" : "バッテリー容量";
  document.getElementById("socPercent").title = (lang === 'en') ? "Battery state of charge" : "バッテリー現状";

  // Default calcRef message
  document.getElementById("calcRef").innerText =
    (lang === 'en')
      ? "Detailed calculations will be shown here based on inputs."
      : "※選択された値に基づいた詳細計算を表示します。";
}

function formatTime(hours) {
  const hr = Math.floor(hours);
  const min = Math.round((hours - hr) * 60);
  return document.documentElement.lang === "en"
    ? `${hr} h ${min} min`
    : `${hr} 時間 ${min} 分`;
}

function calculateTime() {
  const inputVoltage = parseFloat(document.getElementById("inputVoltage").value);
  let inputCurrent = parseFloat(document.getElementById("inputCurrent").value);
  const batteryVoltage = parseFloat(document.getElementById("batteryVoltage").value);
  const batteryAh = parseFloat(document.getElementById("batteryAh").value);
  const socPercent = parseFloat(document.getElementById("socPercent").value);

  const ref = [];
  const isEN = document.documentElement.lang === "en";

  if ([inputVoltage,inputCurrent,batteryVoltage,batteryAh,socPercent].some(isNaN)) {
    alert(isEN ? "Please fill all fields." : "すべての入力欄に値を入力してください。");
    return;
  }
  if (socPercent < 0 || socPercent > 100) {
    alert(isEN ? "SoC must be between 0 and 100." : "SoCは0〜100%の間で入力してください。");
    return;
  }
    if (inputCurrent < 0 || inputCurrent > 400) {
    alert(isEN ? "Input Current must be between 1A and 400A." : "ブレーカーのアンペアは１〜４00Aの間で入力してください。");
    return;
  }

  // Breaker margin: -5%
  inputCurrent *= 0.95;
  ref.push((isEN ? "Corrected input current (-5%): " : "入力電流補正（-5%）：") + `${inputCurrent.toFixed(2)} A`);

  // CC-CV cutoff
  const cutoffVoltage = batteryVoltage * 1.375;
  ref.push((isEN ? "Cut-off voltage: " : "カットオフ電圧：") + `${cutoffVoltage.toFixed(2)} V`);

  // Available AC power (no charger efficiency yet)
  const pf = 0.8;
  const Pac = Math.sqrt(3) * inputVoltage * inputCurrent * pf; // W
  const K = Pac / cutoffVoltage; // A at 100% efficiency (DC side)

  // C-rate limit
  const cLimit = 0.57 * batteryAh;

  // Reference current (for logs & base-time), using 13kW eff = 0.80
  const rawOutputRef = K * 0.80;
  const outputRef = Math.min(rawOutputRef, cLimit);

  // 13kW charger (fixed 0.80), clamp by charger (160A) and C-rate
  const output13 = Math.min(K * 0.80, 160, cLimit);

  // 21kW charger: variable efficiency
  // If K*0.70 <= 160A → low-current zone at eff=0.70; else ramp region 160–320A:
  // Solve fixed-point: I = K*(0.7 + 0.1*(I-160)/160) ⇒ I = 0.6K / (1 - K/1600)
  let powerLimited21;
  if (K * 0.70 <= 160) {
    powerLimited21 = K * 0.70;
  } else {
    const Ifp = (0.6 * K) / (1 - (K / 1600));
    powerLimited21 = Ifp;
  }
  const output21 = Math.min(powerLimited21, 320, cLimit);

  // Report efficiency at the final 21kW current
  const eff21_report = output21 <= 160 ? 0.70
    : output21 >= 320 ? 0.80
    : 0.70 + ((output21 - 160) / 160) * 0.10;

  // Update output boxes
  document.getElementById("outputCurrent13").innerText = output13.toFixed(1);
  document.getElementById("outputCurrent21").innerText = output21.toFixed(1);

  // Breakdown log
  ref.push(
    (isEN
      ? "Calculated output current (breaker current limit based): "
      : "計算出力電流（ブレーカー電流制限基準）："
    ) + `${rawOutputRef.toFixed(2)} A`
  );
  ref.push(
    (isEN ? "[13kW fixed eff: " : "[13kW固定効: ") + "0.80] " +
    (isEN ? "[21kW var eff: " : "[21kW可変効: ") + eff21_report.toFixed(2) + "]"
  );

  ref.push(" ");
  ref.push((isEN ? "C-rate limit (0.57C): " : "Cレート上限（0.57C）：") + `${cLimit.toFixed(2)} A`);
  ref.push((isEN ? "13kW final output current: " : "13kW最終出力電流：") + `${output13.toFixed(2)} A`);
  ref.push((isEN ? "21kW final output current: " : "21kW最終出力電流：") + `${output21.toFixed(2)} A`);

  // SoC & time math
  const socRatio = (100 - socPercent) / 100;
  ref.push((isEN ? "Remaining SoC: " : "残SoC：") + `${(socRatio * 100).toFixed(1)} %`);

  // Baseline: 0%→100% at 0.57C takes 56 min
  const baselineHours = 56 / 60;
  const scaleFactor = cLimit / outputRef;                 // how much faster/slower than 0.57C
  const actualFullChargeHours = baselineHours * scaleFactor;
  const totalHours = actualFullChargeHours * socRatio;    // linear remaining-time

  // Charger-specific times by scaling from the same reference current
  const time13 = totalHours * (outputRef / output13);
  const time21 = totalHours * (outputRef / output21);

  document.getElementById("time13kw").innerText = formatTime(time13);
  document.getElementById("time21kw").innerText = formatTime(time21);

  ref.push(isEN ? "\n[Time breakdown]" : "\n【所要時間の内訳】");
  ref.push((isEN ? "Full-charge base time (0.57C): " : "満充電基準時間（0.57C時）：") + `${baselineHours.toFixed(2)} h`);
  ref.push((isEN ? "Current scaling factor: " : "電流スケーリング係数：") + `${scaleFactor.toFixed(2)}`);
  ref.push((isEN ? "Actual full-charge time: " : "実際の満充電時間：") + `${actualFullChargeHours.toFixed(2)} h`);
  ref.push((isEN ? "Remaining charge time (linear): " : "残充電時間（線形）：") + `${totalHours.toFixed(2)} h`);

  ref.push(isEN ? "\n[Final results]" : "\n【最終結果】");
  ref.push(`13kW: ${formatTime(time13)}`);
  ref.push(`21kW: ${formatTime(time21)}`);

  document.getElementById("calcRef").innerText = ref.join("\n");
}

function clearFields() {
  // Keep inputVoltage & batteryVoltage as requested; clear others.
  ["inputCurrent", "batteryAh", "socPercent"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("outputCurrent13").innerText = "--";
  document.getElementById("outputCurrent21").innerText = "--";
  document.getElementById("time13kw").innerText = "--";
  document.getElementById("time21kw").innerText = "--";
  // Reset message in current language
  document.getElementById("calcRef").innerText =
    (document.documentElement.lang === 'en')
      ? "Detailed calculations will be shown here based on inputs."
      : "※選択された値に基づいた詳細計算を表示します。";
}

// Initialize
setLanguage('jp');
</script>
</body>
</html>

